if(typeof _g==="undefined"||typeof _g.$JOII==="undefined"){throw new Error("JOII-DI requires JOII to be loaded.")}if(typeof _g.$JOII.REVISION==="undefined"||_g.$JOII.REVISION<22){throw new Error("JOII-DI requires JOII 2.2 or higher.")}(function(e,t,n){e("DependencyInjection",{ContainerBuilder:t({container:null,api:null,__construct:function(e){if(typeof e==="undefined"||!e){e=new n.DependencyInjection.Container}this.container=e;this.api={getContainer:this.getContainer.bind(this),loadConfiguration:this.loadConfiguration.bind(this)};return this.api},getContainer:function(){return this.container},loadConfiguration:function(e){if(typeof e!=="object"){throw new Error("loadConfiguration expectes an object, "+typeof e+" given.")}if(typeof e.parameters==="undefined"&&typeof e.services==="undefined"){throw new Error("The configuration object must have a 'parameters' and/or 'services' element.")}if(typeof e.parameters==="object"){this.loadParameters(e.parameters)}if(typeof e.services==="object"){for(var t in e.services){if(!e.services.hasOwnProperty(t)){continue}this.loadService(t,e.services[t])}}return this.api},loadParameters:function(e){for(var t in e){if(!e.hasOwnProperty(t)){continue}this.container.setParameter(t,e[t])}},loadService:function(e,t){var n=this.container.register(e,t["class"]);if(typeof t.arguments!=="undefined"){n.setArguments(t.arguments)}if(typeof t.calls!=="undefined"){n.setMethodCalls(t.calls)}if(typeof t.tags!=="undefined"){n.setTags(t.tags)}}}),Container:t({definitions:{},parameters:{},loading:{},passes:[],is_frozen:false,is_compiling:false,api:null,__construct:function(){this.api={register:this.register.bind(this),get:this.get.bind(this),hasDefinition:this.hasDefinition.bind(this),getDefinition:this.getDefinition.bind(this),addDefinitions:this.addDefinitions.bind(this),setDefinitions:this.setDefinitions.bind(this),setDefinition:this.setDefinition.bind(this),findTaggedServiceIds:this.findTaggedServiceIds.bind(this),getServiceIds:this.getServiceIds.bind(this),setParameters:this.setParameters.bind(this),hasParameter:this.hasParameter.bind(this),setParameter:this.setParameter.bind(this),getParameter:this.getParameter.bind(this),addCompilerPass:this.addCompilerPass.bind(this),compile:this.compile.bind(this),isFrozen:this.isFrozen.bind(this)};return this.api},register:function(e,t){if(this.is_frozen){throw new Error("Unable to register a new Definition on a frozen container.")}this.definitions[e]=new n.DependencyInjection.Definition(t);return this.definitions[e]},addCompilerPass:function(e){if(typeof e==="function"){e=new e}if(typeof e.compile!=="function"){throw new Error("The CompilerPass doesn't have a compile function.")}this.passes.push(e)},compile:function(){if(this.is_compiling){throw new Error("The container is already compiling.")}this.is_compiling=true;if(this.is_frozen){throw new Error("Unable to compile a container which is already compiled.")}for(var e in this.passes){this.passes[e].compile(this.api)}this.is_compiling=false;this.is_frozen=true},isFrozen:function(){return this.is_frozen},get:function(e){if(!this.is_frozen){this.compile()}if(typeof this.definitions[e]==="undefined"){throw new Error("Service "+e+" does not exist.")}var t=this.definitions[e];if(t.hasInstance()){return t.getInstance()}if(this.loading[e]===true){throw new Error("Service "+e+" has a circular reference to itself.")}this.loading[e]=true;var n=this.createService(t);delete this.loading[e];return n},createService:function(e){if(e.hasInstance()){throw new Error("Attempt to create a service that already has an instance.")}var t=this.getParameterArray(e.getArguments());var n=function(e,t){var n=function(){return e.apply(this,t)};n.prototype=e.prototype;return new n};var r=e.getFunction(),i=n(r,t);e.setInstance(i);var s=e.getMethodCalls();for(var o in s){if(!s.hasOwnProperty(o)){continue}var u=s[o][0];var a=this.getParameterArray(s[o][1]||[]);if(typeof i[u]!=="function"){throw new Error("Method "+u+" does not exist.")}i[u].apply(i,a)}return i},getServiceIds:function(){var e=[];for(var t in this.definitions){if(this.definitions.hasOwnProperty(t)){e.push(t)}}return e},setDefinitions:function(e){if(this.is_frozen){throw new Error("Unable to register a new Definition on a frozen container.")}this.definitions={};this.addDefinitions(e);return this.api},addDefinitions:function(e){for(var t in e){if(e.hasOwnProperty(t)){var n=e[t];this.setDefinition(t,n)}}return this.api},setDefinition:function(e,t){if(this.is_frozen){throw new Error("Unable to register a new Definition on a frozen container.")}this.definitions[e]=t;return this.api},hasDefinition:function(e){return typeof this.definitions[e]!=="undefined"},getDefinition:function(e){if(typeof this.definitions[e]==="undefined"){throw new Error("The service definition "+e+" does not exist.")}return this.definitions[e]},findTaggedServiceIds:function(e){var t={};for(var n in this.definitions){if(!this.definitions.hasOwnProperty(n)){continue}if(this.definitions[n].hasTag(e)){t[n]=this.definitions[n].getTag(e)}}return t},setParameters:function(e){if(this.is_frozen){throw new Error("Unable to update parameters on a frozen container.")}this.parameters=e;return this.api},setParameter:function(e,t){if(this.is_frozen){throw new Error("Unable to update parameters on a frozen container.")}this.parameters[e]=t;return this.api},hasParameter:function(e){return typeof this.parameters[e]!=="undefined"},getParameter:function(e){if(typeof this.parameters[e]!=="undefined"){return this.parameters[e]}throw new Error("Parameter "+e+" does not exist.")},getParameterArray:function(e){var t=[];for(var n in e){var r=e[n];if(typeof r==="string"){r=this.resolveParameter(r)}t.push(r)}return t},resolveParameter:function(e){if(typeof e!=="string"){return e}if(e.charAt(0)==="@"){return this.get(e.slice(1,e.length))}if(e.charAt(0)==="%"&&e.charAt(e.length-1)==="%"){return this.getParameter(e.slice(1,e.length-1))}return e}}),Definition:t({name:null,fn:null,instance:null,api:null,is_public:true,args:[],calls:[],tags:{},__construct:function(e){if(typeof e!=="function"){this.fn=this.findFunctionFromString(e)}else{this.fn=e}this.api={addArgument:this.addArgument.bind(this),getArguments:this.getArguments.bind(this),setArguments:this.setArguments.bind(this),addMethodCall:this.addMethodCall.bind(this),setMethodCalls:this.setMethodCalls.bind(this),getMethodCalls:this.getMethodCalls.bind(this),hasMethodCall:this.hasMethodCall.bind(this),removeMethodCall:this.removeMethodCall.bind(this),setTags:this.setTags.bind(this),getTags:this.getTags.bind(this),addTag:this.addTag.bind(this),hasTag:this.hasTag.bind(this),getTag:this.getTag.bind(this),clearTag:this.clearTag.bind(this),clearTags:this.clearTags.bind(this),isPublic:this.isPublic.bind(this),setPublic:this.setPublic.bind(this),hasInstance:this.hasInstance.bind(this),getInstance:this.getInstance.bind(this),setInstance:this.setInstance.bind(this),getFunction:this.getFunction.bind(this)}},addArgument:function(e){if(this.hasInstance()){throw new Error("Unable to update a definition that is already initialized.")}this.args.push(e);return this.api},setArguments:function(e){if(this.hasInstance()){throw new Error("Unable to update a definition that is already initialized.")}this.args=e;return this.api},getArguments:function(){return this.args},setMethodCalls:function(e){if(this.hasInstance()){throw new Error("Unable to update a definition that is already initialized.")}this.calls=[];for(var t in e){if(e.hasOwnProperty(t)){this.calls[t]=e[t]}}return this.api},addMethodCall:function(e,t){if(this.hasInstance()){throw new Error("Unable to update a definition that is already initialized.")}t=t||[];this.calls.push([e,t]);return this.api},removeMethodCall:function(e){if(this.hasInstance()){throw new Error("Unable to update a definition that is already initialized.")}for(var t in this.calls){if(this.calls[t][0]===e){delete this.calls[t]}}return this.api},hasMethodCall:function(e){for(var t in this.calls){if(this.calls[t][0]===e){return true}}return false},getMethodCalls:function(){return this.calls},setTags:function(e){if(this.hasInstance()){throw new Error("Unable to update a definition that is already initialized.")}this.tags=e;return this.api},getTags:function(){return this.tags},getTag:function(e){return typeof this.tags[e]!=="undefined"?this.tags[e]:[]},addTag:function(e,t){if(this.hasInstance()){throw new Error("Unable to update a definition that is already initialized.")}if(typeof this.tags[e]==="undefined"){this.tags[e]=[]}this.tags[e].push(t);return this.api},hasTag:function(e){return typeof this.tags[e]!=="undefined"},clearTag:function(e){if(this.hasInstance()){throw new Error("Unable to update a definition that is already initialized.")}if(typeof this.tags[e]!=="undefined"){delete this.tags[e]}return this.api},clearTags:function(){if(this.hasInstance()){throw new Error("Unable to update a definition that is already initialized.")}this.tags={};return this.api},setPublic:function(e){if(this.hasInstance()){throw new Error("Unable to update a definition that is already initialized.")}this.is_public=e;return this.api},isPublic:function(){return this.is_public},hasInstance:function(){return!!this.instance},getInstance:function(){if(typeof this.instance!=="undefined"){return this.instance}throw new Error("Definition is not initialized.")},setInstance:function(e){if(this.hasInstance()){throw new Error("Unable to update a definition that is already initialized.")}this.instance=e;return this.api},getFunction:function(){return this.fn},findFunctionFromString:function(e){if(e.indexOf(".")===-1){if(typeof _g[e]==="function"){return _g[e]}throw new Error(e+" is undefined or not a function.")}var t=e.split("."),n=_g,r="",i;while(i=t.shift()){r+=i;if(typeof n[i]==="undefined"||typeof n[i]!=="object"&&typeof n[i]!=="function"){throw new Error(r+" is undefined or not iterable.")}n=n[i];r+="."}return n}})})})(_g.$JOII.RegisterInNS,_g.$JOII.PublicAPI.Class,_g.$JOII.Namespace)
